resources:
  - name: prepami_repo
    type: gitRepo
    integration: avinci_gh
    pointer:
      sourceName: shippable/buildami
      branch: master

  - name: ami_reqKick_repo
    type: gitRepo
    integration: avinci_gh
    pointer:
      sourceName: shippable/reqKick
      branch: master

  - name: ami_bits_access_cli
    type: cliConfig
    integration: aws_bits_access
    pointer:
      region: us-east-1

  - name: ami_bits_access
    type: integration
    integration: aws_bits_access

  - name: ami_prod_access
    type: integration
    integration: aws_prod_access

  - name: ship_bits_gcp
    type: cliConfig
    integration: ship_bits_gcp_svc
    versionTemplate:
      region: "us-west1-a"

  - name: baseami_params
    type: params
    version:
      params:
        SOURCE_AMI: "ami-772aa961"
        VPC_ID: "vpc-266f3241"
        SUBNET_ID: "subnet-6df12f24"
        SECURITY_GROUP_ID: "sg-f634518c"
        REGION: "us-east-1"

  - name: u16baseami_params
    type: params
    version:
      params:
        SOURCE_AMI: "ami-66506c1c"
        VPC_ID: "vpc-266f3241"
        SUBNET_ID: "subnet-6df12f24"
        SECURITY_GROUP_ID: "sg-f634518c"
        REGION: "us-east-1"

  - name: admiralami_params
    type: params
    version:
      params:
        SOURCE_AMI: "ami-772aa961"
        VPC_ID: "vpc-2d9a894f"
        SUBNET_ID: "subnet-42bfef04"
        SECURITY_GROUP_ID: "sg-9df159f8"
        REGION: "us-east-1"

  - name: c7baseami_params
    type: params
    version:
      params:
        SOURCE_AMI: "ami-ae7bfdb8"
        VPC_ID: "vpc-266f3241"
        SUBNET_ID: "subnet-6df12f24"
        SECURITY_GROUP_ID: "sg-f634518c"
        REGION: "us-east-1"

  - name: windowsbaseami_params
    type: params
    version:
      params:
        SOURCE_AMI: "ami-603b1c1a"
        REGION: "us-east-1"

  - name: windowsbaseami_winrm_keys
    type: integration
    integration: winrm_creds

  - name: cexec_repo
    type: gitRepo
    integration: avinci_gh
    pointer:
      sourceName: shippable/cexec
      branch: master

  - name: node_repo
    type: gitRepo
    integration: avinci_gh
    pointer:
      sourceName: shippable/node
      branch: master

jobs:
  - name: trig_gcp_img_prep
    type: runSh
    steps:
      - TASK:
          script:
            - ls -al

######################### GCP Win 2016 Image ##################################
  - name: w2k16_x86_64_gcp_img_prep
    type: runSh
    triggerMode: parallel
    dependencyMode: strict
    steps:
      - IN: trig_gcp_img_prep
      - IN: prepami_repo
        switch: off
      - IN: ship_bits_gcp
        switch: off
      - TASK:
          name: prep_w2k16_gce_image
          runtime:
            options:
              env:
                - SOURCE_IMAGE_FAMILY: "windows-2016"
                - MACHINE_TYPE: "n1-standard-8"
                - REGION: "us-east1"
                - ZONE: "us-east1-b"
                - PROJECT_ID: "ship-bits"
                - SERVICE_ACCOUNT_JSON: "gcp_key.json"
                - REL_VER: "master"
                - WINRM_USERNAME: "packer_user"
          script:
            - pushd $(shipctl get_resource_state "prepami_repo")/gcp/x86_64/WindowsServer_2016/prep
            - export REL_VER_DASH=${REL_VER//./-}
            - export FAM_NAME=$REL_VER_DASH"-prep-w2k16-x86-64"
            - echo $(shipctl get_integration_resource_field ship_bits_gcp JSON_key) > $SERVICE_ACCOUNT_JSON
            - shipctl replace vars.json
            - packer validate -var-file=vars.json packer.json
            - packer build -machine-readable -var-file=vars.json packer.json 2>&1 | tee output.txt
            - export IMAGE_NAME=$(cat output.txt | awk -F, '$0 ~/artifact,0,id/ {print $6}' | cut -d':' -f 2)
    on_success:
      script:
        - shipctl put_resource_state_multi $JOB_NAME "versionName=$IMAGE_NAME" "IMAGE_NAME=$IMAGE_NAME" "IMAGE_FAM_NAME=$FAM_NAME" "REL_VER=$REL_VER"
        - shipctl copy_file_to_state images.txt
    on_failure:
      script:
        - cat output.txt

  - name: w2k16_x86_64_gcp_img_patch
    type: runSh
    triggerMode: parallel
    dependencyMode: strict
    steps:
      - IN: w2k16_x86_64_gcp_img_prep
      - IN: node_repo
      - IN: cexec_repo
      - IN: w2k16_reqProc_x86_64_build
      - IN: ami_reqKick_repo
      - IN: prepami_repo
        switch: off
      - IN: ship_bits_gcp
        switch: off
      - TASK:
          name: patch_w2k16_gce_image
          runtime:
            options:
              env:
                - MACHINE_TYPE: "n1-standard-8"
                - REGION: "us-east1"
                - ZONE: "us-east1-b"
                - PROJECT_ID: "ship-bits"
                - SERVICE_ACCOUNT_JSON: "gcp_key.json"
                - WINRM_USERNAME: "packer_user"
          script:
            - pushd $(shipctl get_resource_state "prepami_repo")/gcp/x86_64/WindowsServer_2016/patch
            - shipctl copy_file_from_resource_state "w2k16_x86_64_gcp_img_prep" "images.txt" .
            - export SOURCE_IMAGE_FAMILY=$(shipctl get_resource_version_key w2k16_x86_64_gcp_img_prep IMAGE_FAM_NAME)
            - export REL_VER=$(shipctl get_resource_version_key w2k16_x86_64_gcp_img_prep REL_VER)
            - export REL_VER_DASH=${REL_VER//./-}
            - export FAM_NAME=$REL_VER_DASH"-patch-w2k16-x86-64"
            - echo $(shipctl get_integration_resource_field ship_bits_gcp JSON_key) > $SERVICE_ACCOUNT_JSON
            - shipctl replace vars.json
            - packer validate -var-file=vars.json packer.json
            - packer build -machine-readable -var-file=vars.json packer.json 2>&1 | tee output.txt
            - export IMAGE_NAME=$(cat output.txt | awk -F, '$0 ~/artifact,0,id/ {print $6}' | cut -d':' -f 2)
    on_success:
      script:
        - shipctl put_resource_state_multi $JOB_NAME "versionName=$IMAGE_NAME" "IMAGE_NAME=$IMAGE_NAME" "IMAGE_FAM_NAME=$FAM_NAME" "REL_VER=$REL_VER"
        - shipctl copy_file_to_state images.txt
    on_failure:
      script:
        - cat output.txt

  - name: w2k16_x86_64_gcp_img_final
    type: runSh
    triggerMode: parallel
    dependencyMode: strict
    steps:
      - IN: dry_dh_x86_64_Windows_tag_push
      - IN: gh_ship_repos_tag_push
      - IN: reports_tag_push
      - IN: prepami_repo
        switch: off
      - IN: w2k16_x86_64_gcp_img_patch
        switch: off
      - IN: prod_release
        switch: off
      - IN: ship_bits_gcp
        switch: off
      - TASK:
          name: final_w2k16_gce_image
          runtime:
            options:
              env:
                - MACHINE_TYPE: "n1-standard-8"
                - REGION: "us-east1"
                - ZONE: "us-east1-b"
                - PROJECT_ID: "ship-bits"
                - SERVICE_ACCOUNT_JSON: "gcp_key.json"
                - WINRM_USERNAME: "packer_user"
          script:
            - pushd $(shipctl get_resource_state "prepami_repo")/gcp/x86_64/WindowsServer_2016/final
            - shipctl copy_file_from_resource_state "w2k16_x86_64_gcp_img_patch" "images.txt" .
            - export REL_VER=$(shipctl get_resource_version_key "prod_release" versionName)
            - export REL_VER_DASH=${REL_VER//./-}
            - export IMG_VER=$REL_VER
            - export FAM_NAME=$REL_VER_DASH"-final-w2k16-x86-64"
            - export SOURCE_IMAGE_FAMILY=$(shipctl get_resource_version_key w2k16_x86_64_gcp_img_patch IMAGE_FAM_NAME)
            - echo $(shipctl get_integration_resource_field ship_bits_gcp JSON_key) > $SERVICE_ACCOUNT_JSON
            - shipctl replace vars.json
            - packer validate -var-file=vars.json packer.json
            - packer build -machine-readable -var-file=vars.json packer.json 2>&1 | tee output.txt
            - export IMAGE_NAME=$(cat output.txt | awk -F, '$0 ~/artifact,0,id/ {print $6}' | cut -d':' -f 2)
    on_success:
      script:
        - shipctl put_resource_state_multi $JOB_NAME "versionName=$IMAGE_NAME" "IMAGE_NAME=$IMAGE_NAME" "IMAGE_FAM_NAME=$FAM_NAME" "REL_VER=$REL_VER" "IMG_VER=$IMG_VER"
        - shipctl copy_file_to_state images.txt
    on_failure:
      script:
        - cat output.txt

  - name: w2k16_x86_64_gcp_img_v634
    type: runSh
    dependencyMode: strict
    triggerMode: parallel
    steps:
      - IN: gh_ship_repos_tag_push
      - IN: reports_tag_push
      - IN: prepami_repo
        switch: off
      - IN: prod_release
        switch: off
      - IN: ship_bits_gcp
        switch: off
      - IN: w2k16_x86_64_gcp_img_final
        switch: off
      - TASK:
          name: v634_w2k16_gce_image
          runtime:
            options:
              env:
                - MACHINE_TYPE: "n1-standard-8"
                - REGION: "us-east1"
                - ZONE: "us-east1-b"
                - PROJECT_ID: "ship-bits"
                - SERVICE_ACCOUNT_JSON: "gcp_key.json"
                - WINRM_USERNAME: "packer_user"
                - IMG_VER: "v6.3.4"
          script:
            - pushd $(shipctl get_resource_state "prepami_repo")/gcp/x86_64/WindowsServer_2016/final
            - shipctl copy_file_from_resource_state "w2k16_x86_64_gcp_img_final" "images.txt" .
            - export REL_VER=$(shipctl get_resource_version_name "prod_release")
            - export IMG_VER_DASH=${IMG_VER//./-}
            - export FAM_NAME=$IMG_VER_DASH"-final-w2k16-x86-64"
            - echo $(shipctl get_integration_resource_field ship_bits_gcp JSON_key) > $SERVICE_ACCOUNT_JSON
            - shipctl replace vars.json
            - packer validate -var-file=vars.json packer.json
            - packer build -machine-readable -var-file=vars.json packer.json 2>&1 | tee output.txt
            - export IMAGE_NAME=$(cat output.txt | awk -F, '$0 ~/artifact,0,id/ {print $6}' | cut -d':' -f 2)
    on_success:
      script:
        - shipctl put_resource_state_multi $JOB_NAME "versionName=$IMAGE_NAME" "IMAGE_NAME=$IMAGE_NAME" "IMAGE_FAM_NAME=$FAM_NAME" "REL_VER=$REL_VER" "IMG_VER=$IMG_VER"
    on_failure:
      script:
        - cat output.txt

######################### Admiral Image ##################################
  - name: baseadmiralami_prep
    type: runSh
    triggerMode: parallel
    dependencyMode: strict
    steps:
      - IN: prepami_repo
        switch: off
      - IN: ami_bits_access
        switch: off
      - IN: ami_prod_access
        switch: off
      - IN: admiralami_params
        switch: off
      - TASK:
          script:
            - pushd $(shipctl get_resource_state "prepami_repo")
            - cd admiral
            - ./admiralPack.sh baseadmiralami_prep ami_bits_access ami_prod_access
            - popd
    on_failure:
      - script: echo 'failed'
      - NOTIFY: rc_slack

  - name: finaladmiralami_prep
    type: runSh
    dependencyMode: strict
    triggerMode: parallel
    steps:
      - IN: prepami_repo
        switch: off
      - IN: baseadmiralami_prep
        switch: off
      - IN: ami_bits_access
        switch: off
      - IN: ami_prod_access
        switch: off
      - IN: prod_release
        switch: off
      - IN: admiralami_params
        switch: off
      - IN: genexec_tag_push
      - IN: gh_ship_repos_tag_push
      - IN: ship_ecr_x86_64_Ubuntu_tag_push
      - TASK:
          script:
            - pushd $(shipctl get_resource_state "prepami_repo")
            - cd admiralPatch
            - ./admiralPatchPack.sh finaladmiralami_prep baseadmiralami_prep prod_release ami_bits_access ami_prod_access
            - popd
    on_success:
      - script: echo 'SUCCESS'
    on_failure:
      - script: cat /build/IN/prepami_repo/gitRepo/admiralPatch/output.txt


  ###################
  # u14 AMI jobs
  ###################
  - name: baseami_prep
    type: runSh
    triggerMode: parallel
    dependencyMode: strict
    steps:
      - IN: prepami_repo
        switch: off
      - IN: ami_bits_access_cli
        switch: off
      - IN: baseami_params
        switch: off
      - IN: u16cppall_dd_img
      - IN: u16phpall_dd_img
      - IN: u16ruball_dd_img
      - IN: u16scaall_dd_img
      - IN: u16golall_dd_img
      - IN: u16cloall_dd_img
      - IN: u16pytall_dd_img
      - IN: u16nodall_dd_img
      - IN: u16javall_dd_img
      - IN: u14nodall_dd_img
      - IN: u14pytall_dd_img
      - IN: u14cloall_dd_img
      - IN: u14golall_dd_img
      - IN: u14scaall_dd_img
      - IN: u14ruball_dd_img
      - IN: u14phpall_dd_img
      - IN: u14cppall_dd_img
      - IN: u14javall_dd_img
      - IN: node_repo
      - IN: cexec_repo
      - IN: u14_reqProc_x8664_build
      - IN: ami_reqKick_repo
      - TASK:
          script:
            - pushd $(shipctl get_resource_state "prepami_repo")
            - cd base
            - ./basePack.sh baseami_prep ami_bits_access_cli
            - popd
    on_failure:
      - script: cat IN/prepami_repo/gitRepo/base/output.txt #TODO change to standard syntax

  - name: baseami_patch
    type: runSh
    triggerMode: parallel
    dependencyMode: strict
    steps:
      - IN: prepami_repo
        switch: off
      - IN: ami_bits_access_cli
        switch: off
      - IN: baseami_params
        switch: off
      - IN: cexec_repo
      - IN: node_repo
      - IN: u14_reqProc_x8664_build
      - IN: ami_reqKick_repo
      - IN: baseami_prep
      - TASK:
          script:
            - pushd $(shipctl get_resource_state "prepami_repo")
            - cd basePatch
            - ./basePatchPack.sh baseami_patch ami_bits_access_cli baseami_prep
            - popd
    on_failure:
      - script: cat IN/prepami_repo/gitRepo/basePatch/output.txt #TODO change to standard syntax

  - name: finalami_prep
    type: runSh
    triggerMode: parallel
    dependencyMode: strict
    steps:
      - IN: prepami_repo
        switch: off
      - IN: baseami_patch
        switch: off
      - IN: prod_release
        switch: off
      - IN: baseami_params
        switch: off
      - IN: ami_bits_access
        switch: off
      - IN: dry_dh_x86_64_Ubuntu_tag_push
      - IN: dry_dh_x86_64_u16_tag_push
      - IN: gh_ship_repos_tag_push
      - IN: reports_tag_push
      - TASK:
          script:
            - pushd $(shipctl get_resource_state "prepami_repo")
            - cd exec
            - ./execPack.sh finalami_prep prod_release baseami_patch ami_bits_access
            - popd
    on_failure:
      - script: cat /build/IN/prepami_repo/gitRepo/exec/output.txt

  - name: stable_update
    type: runSh
    dependencyMode: strict
    triggerMode: parallel
    steps:
      - IN: prepami_repo
        switch: off
      - IN: prod_release
        switch: off
      - IN: baseami_params
        switch: off
      - IN: ami_bits_access
        switch: off
      - IN: gh_ship_repos_tag_push
      - IN: reports_tag_push
      - TASK:
          script:
            - pushd $(shipctl get_resource_state "prepami_repo")
            - cd exec
            - ./execPackUpdate.sh stable_update prod_release ami-4ae41a5c stable ami_bits_access
            - popd
    on_failure:
      - script: cat /build/IN/prepami_repo/gitRepo/exec/output.txt

  - name: unstable_update
    type: runSh
    dependencyMode: strict
    triggerMode: parallel
    steps:
      - IN: prepami_repo
        switch: off
      - IN: prod_release
        switch: off
      - IN: baseami_params
        switch: off
      - IN: ami_bits_access
        switch: off
      - IN: gh_ship_repos_tag_push
      - IN: reports_tag_push
      - TASK:
          script:
            - pushd $(shipctl get_resource_state "prepami_repo")
            - cd exec
            - ./execPackUpdate.sh unstable_update prod_release ami-90fd0286 unstable ami_bits_access
            - popd
    on_failure:
      - script: cat /build/IN/prepami_repo/gitRepo/exec/output.txt

  - name: v532_update
    type: runSh
    dependencyMode: strict
    triggerMode: parallel
    steps:
      - IN: prepami_repo
        switch: off
      - IN: prod_release
        switch: off
      - IN: baseami_params
        switch: off
      - IN: ami_bits_access
        switch: off
      - IN: gh_ship_repos_tag_push
      - IN: reports_tag_push
      - TASK:
          script:
            - pushd $(shipctl get_resource_state "prepami_repo")
            - cd exec
            - ./execPackUpdate.sh v532_update prod_release ami-3b972d2d v532 ami_bits_access
            - popd
    on_failure:
      - script: cat /build/IN/prepami_repo/gitRepo/exec/output.txt

  - name: v541_update
    type: runSh
    dependencyMode: strict
    triggerMode: parallel
    steps:
      - IN: prepami_repo
        switch: off
      - IN: prod_release
        switch: off
      - IN: baseami_params
        switch: off
      - IN: ami_bits_access
        switch: off
      - IN: gh_ship_repos_tag_push
      - IN: reports_tag_push
      - TASK:
          script:
            - pushd $(shipctl get_resource_state "prepami_repo")
            - cd exec
            - ./execPackUpdate.sh v541_update prod_release ami-90813b86 v541 ami_bits_access
            - popd
    on_failure:
      - script: cat /build/IN/prepami_repo/gitRepo/exec/output.txt

  - name: v551_update
    type: runSh
    dependencyMode: strict
    triggerMode: parallel
    steps:
      - IN: prepami_repo
        switch: off
      - IN: prod_release
        switch: off
      - IN: baseami_params
        switch: off
      - IN: ami_bits_access
        switch: off
      - IN: gh_ship_repos_tag_push
      - IN: reports_tag_push
      - TASK:
          script:
            - pushd $(shipctl get_resource_state "prepami_repo")
            - cd exec
            - ./execPackUpdate.sh v551_update prod_release ami-4b36535d v551 ami_bits_access
            - popd
    on_failure:
      - script: cat /build/IN/prepami_repo/gitRepo/exec/output.txt

  - name: v561_update
    type: runSh
    dependencyMode: strict
    triggerMode: parallel
    steps:
      - IN: prepami_repo
        switch: off
      - IN: prod_release
        switch: off
      - IN: baseami_params
        switch: off
      - IN: ami_bits_access
        switch: off
      - IN: gh_ship_repos_tag_push
      - IN: reports_tag_push
      - TASK:
          script:
            - pushd $(shipctl get_resource_state "prepami_repo")
            - cd exec
            - ./execPackUpdate.sh v561_update prod_release ami-c0a5f5d6 v561 ami_bits_access
            - popd
    on_failure:
      - script: cat /build/IN/prepami_repo/gitRepo/exec/output.txt

  - name: v573_update
    type: runSh
    dependencyMode: strict
    triggerMode: parallel
    steps:
      - IN: prepami_repo
        switch: off
      - IN: prod_release
        switch: off
      - IN: baseami_params
        switch: off
      - IN: ami_bits_access
        switch: off
      - IN: gh_ship_repos_tag_push
      - IN: reports_tag_push
      - TASK:
          script:
            - pushd $(shipctl get_resource_state "prepami_repo")
            - cd exec
            - ./execPackUpdate.sh v573_update prod_release ami-b9cfdeaf v573 ami_bits_access
            - popd
    on_failure:
      - script: cat /build/IN/prepami_repo/gitRepo/exec/output.txt

  - name: v582_update
    type: runSh
    dependencyMode: strict
    triggerMode: parallel
    steps:
      - IN: prepami_repo
        switch: off
      - IN: prod_release
        switch: off
      - IN: baseami_params
        switch: off
      - IN: ami_bits_access
        switch: off
      - IN: gh_ship_repos_tag_push
      - IN: reports_tag_push
      - TASK:
          script:
            - pushd $(shipctl get_resource_state "prepami_repo")
            - cd exec
            - ./execPackUpdate.sh v582_update prod_release ami-f9d6e782 v582 ami_bits_access
            - popd
    on_failure:
      - script: cat /build/IN/prepami_repo/gitRepo/exec/output.txt

  - name: v5104_update
    type: runSh
    dependencyMode: strict
    triggerMode: parallel
    steps:
      - IN: prepami_repo
        switch: off
      - IN: prod_release
        switch: off
      - IN: baseami_params
        switch: off
      - IN: ami_bits_access
        switch: off
      - IN: gh_ship_repos_tag_push
      - IN: reports_tag_push
      - TASK:
          script:
            - pushd $(shipctl get_resource_state "prepami_repo")
            - cd exec
            - ./execPackUpdate.sh v5104_update prod_release ami-312b8d4b v5104 ami_bits_access
            - popd
    on_failure:
      - script: cat /build/IN/prepami_repo/gitRepo/exec/output.txt

  - name: v614_update
    type: runSh
    dependencyMode: strict
    triggerMode: parallel
    steps:
      - IN: prepami_repo
        switch: off
      - IN: prod_release
        switch: off
      - IN: baseami_params
        switch: off
      - IN: ami_bits_access
        switch: off
      - IN: gh_ship_repos_tag_push
      - IN: reports_tag_push
      - TASK:
          script:
            - pushd $(shipctl get_resource_state "prepami_repo")
            - cd exec
            - ./execPackUpdate.sh v614_update prod_release ami-874d4bfd v614 ami_bits_access
            - popd
    on_failure:
      - script: cat /build/IN/prepami_repo/gitRepo/exec/output.txt

  - name: v624_update
    type: runSh
    dependencyMode: strict
    triggerMode: parallel
    steps:
      - IN: prepami_repo
        switch: off
      - IN: prod_release
        switch: off
      - IN: baseami_params
        switch: off
      - IN: ami_bits_access
        switch: off
      - IN: gh_ship_repos_tag_push
      - IN: reports_tag_push
      - TASK:
          script:
            - pushd $(shipctl get_resource_state "prepami_repo")
            - cd exec
            - ./execPackUpdate.sh v624_update prod_release ami-32d5274f v624 ami_bits_access
            - popd
    on_failure:
      - script: cat /build/IN/prepami_repo/gitRepo/exec/output.txt

  - name: v634_update
    type: runSh
    dependencyMode: strict
    triggerMode: parallel
    steps:
      - IN: prepami_repo
        switch: off
      - IN: prod_release
        switch: off
      - IN: baseami_params
        switch: off
      - IN: ami_bits_access
        switch: off
      - IN: gh_ship_repos_tag_push
      - IN: reports_tag_push
      - TASK:
          script:
            - pushd $(shipctl get_resource_state "prepami_repo")
            - cd exec
            - ./execPackUpdate.sh v634_update prod_release ami-f156f78c v634 ami_bits_access
            - popd
    on_failure:
      - script: cat /build/IN/prepami_repo/gitRepo/exec/output.txt

  ###################
  # u16 AMI jobs
  ###################
  - name: u16baseami_prep
    type: runSh
    triggerMode: parallel
    dependencyMode: strict
    steps:
      - IN: prepami_repo
        switch: off
      - IN: ami_bits_access_cli
        switch: off
      - IN: u16baseami_params
        switch: off
      - IN: u16cppall_dd_img
      - IN: u16phpall_dd_img
      - IN: u16ruball_dd_img
      - IN: u16scaall_dd_img
      - IN: u16javall_dd_img
      - IN: u16golall_dd_img
      - IN: u16cloall_dd_img
      - IN: u16pytall_dd_img
      - IN: u16nodall_dd_img
      - IN: node_repo
      - IN: cexec_repo
      - IN: u16_reqProc_x8664_build
      - IN: ami_reqKick_repo
      - TASK:
          script:
            - pushd $(shipctl get_resource_state "prepami_repo")
            - cd u16Base
            - ./basePack.sh u16baseami_prep ami_bits_access_cli
            - popd
    on_failure:
      - script: cat $(shipctl get_resource_state prepami_repo)/u16Base/output.txt

  - name: u16baseami_patch
    type: runSh
    triggerMode: parallel
    dependencyMode: strict
    steps:
      - IN: prepami_repo
        switch: off
      - IN: ami_bits_access_cli
        switch: off
      - IN: u16baseami_params
        switch: off
      - IN: cexec_repo
      - IN: node_repo
      - IN: u16_reqProc_x8664_build
      - IN: ami_reqKick_repo
      - IN: u16baseami_prep
      - TASK:
          script:
            - pushd $(shipctl get_resource_state "prepami_repo")
            - cd u16BasePatch
            - ./basePatchPack.sh u16baseami_patch ami_bits_access_cli u16baseami_prep
            - popd
    on_failure:
      - script: cat $(shipctl get_resource_state prepami_repo)/u16BasePatch/output.txt #TODO change to standard syntax

  - name: u16finalami_prep
    type: runSh
    triggerMode: parallel
    dependencyMode: strict
    steps:
      - IN: prepami_repo
        switch: off
      - IN: u16baseami_patch
        switch: off
      - IN: prod_release
        switch: off
      - IN: u16baseami_params
        switch: off
      - IN: ami_bits_access
        switch: off
      - IN: dry_dh_x86_64_u16_tag_push
      - IN: gh_ship_repos_tag_push
      - IN: reports_tag_push
      - TASK:
          script:
            - pushd $(shipctl get_resource_state "prepami_repo")
            - cd u16Exec
            - ./execPack.sh u16finalami_prep prod_release u16baseami_patch ami_bits_access
            - popd
    on_failure:
      - script: cat $(shipctl get_resource_state prepami_repo)/u16Exec/output.txt

  - name: u16_v634_update
    type: runSh
    dependencyMode: strict
    triggerMode: parallel
    steps:
      - IN: prepami_repo
        switch: off
      - IN: prod_release
        switch: off
      - IN: baseami_params
        switch: off
      - IN: ami_bits_access
        switch: off
      - IN: gh_ship_repos_tag_push
      - IN: reports_tag_push
      - TASK:
          script:
            - pushd $(shipctl get_resource_state "prepami_repo")
            - cd u16Exec
            - ./execPackUpdate.sh u16_v634_update prod_release ami-6158f91c v634 ami_bits_access
            - popd
    on_failure:
      - script: cat /build/IN/prepami_repo/gitRepo/u16Exec/output.txt

  ###################
  # w16 AMI jobs
  ###################
  - name: windowsbaseami_prep
    type: runSh
    triggerMode: parallel
    dependencyMode: strict
    steps:
      - IN: prepami_repo
        switch: off
      - IN: ami_bits_access_cli
        switch: off
      - IN: windowsbaseami_params
        switch: off
      - IN: windowsbaseami_winrm_keys
        switch: off
      - IN: w2k16_dd_img
      - IN: w2k16dotnetcore_dd_img
      - IN: w2k16aspnetcore_dd_img
      - IN: w2k16_reqProc_x86_64_build
      - TASK:
          script:
            - pushd $(shipctl get_resource_state "prepami_repo")
            - cd windowsBase
            - sed -i "s/{{%WINRM_USERNAME%}}/$WINRM_USERNAME/g" ./bootstrap_win.txt
            - sed -i "s/{{%WINRM_PASSWORD%}}/$WINRM_PASSWORD/g" ./bootstrap_win.txt
            - ./basePack.sh windowsbaseami_prep ami_bits_access_cli
            - popd
    on_failure:
      - script: pushd $(shipctl get_resource_state "prepami_repo")
      - script: cd windowsBase
      - script: cat output.txt
      - script: popd

  - name: windowsbaseami_patch
    type: runSh
    triggerMode: parallel
    dependencyMode: strict
    steps:
      - IN: prepami_repo
        switch: off
      - IN: ami_bits_access_cli
        switch: off
      - IN: windowsbaseami_params
        switch: off
      - IN: windowsbaseami_winrm_keys
        switch: off
      - IN: cexec_repo
      - IN: node_repo
      - IN: w2k16_reqProc_x86_64_build
      - IN: ami_reqKick_repo
      - IN: windowsbaseami_prep
      - TASK:
          name: patch_w16_aws_image
          script:
            - pushd $(shipctl get_resource_state "prepami_repo")/windowsBasePatch
            - export AWS_ACCESS_KEY_ID=$(shipctl get_integration_resource_field ami_bits_access_cli "accessKey")
            - export AWS_SECRET_ACCESS_KEY=$(shipctl get_integration_resource_field ami_bits_access_cli "secretKey")
            - export AMI_ID=$(shipctl get_resource_version_key windowsbaseami_prep versionName)
            - export RES_IMG_VER_NAME_DASH=$(shipctl get_resource_version_key windowsbaseami_prep RES_IMG_VER_NAME_DASH)
            - export RES_IMG_VER_NAME=$(shipctl get_resource_version_key windowsbaseami_prep RES_IMG_VER_NAME)
            - shipctl replace bootstrap_win.txt vars.json
            - packer validate -var-file=vars.json basePatchAMI.json
            - packer build -machine-readable -var-file=vars.json basePatchAMI.json 2>&1 | tee output.txt
            - export IMAGE_NAME=$(cat output.txt | awk -F, '$0 ~/artifact,0,id/ {print $6}' | cut -d':' -f 2)
    on_success:
      script:
        - shipctl put_resource_state_multi $JOB_NAME "versionName=$IMAGE_NAME" "IMAGE_NAME=$IMAGE_NAME" "RES_IMG_VER_NAME=$RES_IMG_VER_NAME" "RES_IMG_VER_NAME_DASH=$RES_IMG_VER_NAME_DASH"
        - shipctl copy_file_to_state images.txt
    on_failure:
      script:
        - cat output.txt

  - name: windowsfinalami_prep
    type: runSh
    triggerMode: parallel
    dependencyMode: strict
    steps:
      - IN: prepami_repo
        switch: off
      - IN: ami_bits_access
        switch: off
      - IN: windowsbaseami_params
        switch: off
      - IN: windowsbaseami_winrm_keys
        switch: off
      - IN: windowsbaseami_patch
        switch: off
      - IN: prod_release
        switch: off
      - IN: dry_dh_x86_64_Windows_tag_push
      - IN: gh_ship_repos_tag_push
      - IN: reports_tag_push
      - TASK:
          script:
            - pushd $(shipctl get_resource_state "prepami_repo")
            - cd windowsExec
            - sed -i "s/{{%WINRM_USERNAME%}}/$WINRM_USERNAME/g" ./bootstrap_win.txt
            - sed -i "s/{{%WINRM_PASSWORD%}}/$WINRM_PASSWORD/g" ./bootstrap_win.txt
            - ./execPack.sh windowsfinalami_prep prod_release windowsbaseami_patch ami_bits_access
            - popd
    on_failure:
      - script: pushd $(shipctl get_resource_state "prepami_repo")
      - script: cd windowsExec
      - script: cat output.txt
      - script: popd

  - name: windows_v634_update
    type: runSh
    dependencyMode: strict
    triggerMode: parallel
    steps:
      - IN: prepami_repo
        switch: off
      - IN: windowsbaseami_params
        switch: off
      - IN: windowsbaseami_winrm_keys
        switch: off
      - IN: windowsfinalami_prep
        switch: off
      - IN: prod_release
        switch: off
      - IN: baseami_params
        switch: off
      - IN: ami_bits_access
        switch: off
      - IN: gh_ship_repos_tag_push
      - IN: reports_tag_push
      - TASK:
          script:
            - pushd $(shipctl get_resource_state "prepami_repo")
            - cd windowsExec
            - ./execPackUpdate.sh windows_v634_update prod_release ami-460cab3b v634 ami_bits_access
            - popd
    on_failure:
      - script: cat /build/IN/prepami_repo/gitRepo/windowsExec/output.txt

  ###################
  # c7 AMI jobs
  ###################
  - name: c7baseami_prep
    type: runSh
    triggerMode: parallel
    dependencyMode: strict
    steps:
      - IN: prepami_repo
        switch: off
      - IN: ami_bits_access_cli
        switch: off
      - IN: c7baseami_params
        switch: off
      - IN: c7nodall_dd_img
      - IN: c7cppall_dd_img
      - IN: c7pytall_dd_img
      - IN: c7javall_dd_img
      - IN: node_repo
      - IN: cexec_repo
      - IN: u16_reqProc_x8664_build
      - IN: ami_reqKick_repo
      - TASK:
          script:
            - pushd $(shipctl get_resource_state "prepami_repo")
            - cd c7Base
            - ./basePack.sh c7baseami_prep ami_bits_access_cli
            - popd
    on_failure:
      - script: pushd $(shipctl get_resource_state "prepami_repo")
      - script: cd c7Base
      - script: cat output.txt
      - script: popd

  - name: c7baseami_patch
    type: runSh
    triggerMode: parallel
    dependencyMode: strict
    steps:
      - IN: prepami_repo
        switch: off
      - IN: ami_bits_access_cli
        switch: off
      - IN: c7baseami_params
        switch: off
      - IN: cexec_repo
      - IN: node_repo
      - IN: u16_reqProc_x8664_build
      - IN: ami_reqKick_repo
      - IN: c7baseami_prep
      - TASK:
          script:
            - pushd $(shipctl get_resource_state "prepami_repo")
            - cd c7BasePatch
            - ./basePatchPack.sh c7baseami_patch ami_bits_access_cli c7baseami_prep
            - popd
    on_failure:
      - script: cat $(shipctl get_resource_state prepami_repo)/c7BasePatch/output.txt

  - name: c7finalami_prep
    type: runSh
    triggerMode: parallel
    dependencyMode: strict
    steps:
      - IN: c7_x8664_tag
      - IN: c7all_x8664_tag
      - IN: c7nodall_x8664_tag
      - IN: c7pytall_x8664_tag
      - IN: c7javall_x8664_tag
      - IN: c7cppall_x8664_tag
      - IN: gh_ship_repos_tag_push
      - IN: reports_tag_push
      - IN: prepami_repo
        switch: off
      - IN: c7baseami_patch
        switch: off
      - IN: prod_release
        switch: off
      - IN: c7baseami_params
        switch: off
      - IN: ami_bits_access
        switch: off

      - TASK:
          script:
            - pushd $(shipctl get_resource_state "prepami_repo")
            - cd c7Exec
            - ./execPack.sh c7finalami_prep prod_release c7baseami_patch ami_bits_access
            - popd
    on_failure:
      - script: cat $(shipctl get_resource_state prepami_repo)/c7Exec/output.txt

  - name: c7_v634_update
    type: runSh
    dependencyMode: strict
    triggerMode: parallel
    steps:
      - IN: prepami_repo
        switch: off
      - IN: prod_release
        switch: off
      - IN: baseami_params
        switch: off
      - IN: ami_bits_access
        switch: off
      - IN: gh_ship_repos_tag_push
      - IN: reports_tag_push
      - TASK:
          script:
            - pushd $(shipctl get_resource_state "prepami_repo")
            - cd c7Exec
            - ./execPackUpdate.sh c7_v634_update prod_release ami-a86dc9d5 v634 ami_bits_access
            - popd
    on_failure:
      - script: cat /build/IN/prepami_repo/gitRepo/c7Exec/output.txt
